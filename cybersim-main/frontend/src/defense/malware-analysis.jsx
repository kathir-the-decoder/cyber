import React, { useState, useEffect } from 'react';
import '../labs.css';

const MalwareAnalysisLab = ({ onClose }) => {
  const [currentStep, setCurrentStep] = useState(0);
  const [terminalOutput, setTerminalOutput] = useState([]);
  const [userInput, setUserInput] = useState('');
  const [score, setScore] = useState(0);
  const [labCompleted, setLabCompleted] = useState(false);
  const [analysisFindings, setAnalysisFindings] = useState([]);

  const steps = [
    {
      title: "Static Analysis - File Information",
      description: "Gather basic information about the suspicious file without executing it.",
      expectedCommand: "file suspicious_malware.exe",
      hint: "Use 'file suspicious_malware.exe' to identify the file type",
      successMessage: "File identified as PE32 executable. This is a Windows executable file.",
      points: 20
    },
    {
      title: "Hash Analysis",
      description: "Calculate file hashes to check against malware databases.",
      expectedCommand: "md5sum suspicious_malware.exe && sha256sum suspicious_malware.exe",
      hint: "Use 'md5sum suspicious_malware.exe && sha256sum suspicious_malware.exe' to get file hashes",
      successMessage: "Hashes calculated. MD5: a1b2c3d4... SHA256: e5f6g7h8... Ready for database lookup.",
      points: 25
    },
    {
      title: "Strings Analysis",
      description: "Extract readable strings from the binary to find clues about its behavior.",
      expectedCommand: "strings suspicious_malware.exe | grep -i 'http\\|registry\\|system32'",
      hint: "Use 'strings suspicious_malware.exe | grep -i 'http\\|registry\\|system32'' to find suspicious strings",
      successMessage: "Found suspicious strings: C2 server URLs, registry keys, and system file references.",
      points: 30
    },
    {
      title: "Packed Binary Detection",
      description: "Check if the malware is packed or obfuscated to evade detection.",
      expectedCommand: "upx -t suspicious_malware.exe",
      hint: "Use 'upx -t suspicious_malware.exe' to test if the file is UPX packed",
      successMessage: "Binary is UPX packed! This is a common evasion technique used by malware.",
      points: 25
    },
    {
      title: "Dynamic Analysis Setup",
      description: "Prepare a safe sandbox environment for dynamic analysis.",
      expectedCommand: "cuckoo submit suspicious_malware.exe",
      hint: "Use 'cuckoo submit suspicious_malware.exe' to submit the file to Cuckoo Sandbox",
      successMessage: "File submitted to sandbox. Analysis ID: 12345. Monitoring behavioral patterns.",
      points: 30
    },
    {
      title: "Network Traffic Analysis",
      description: "Analyze network communications during malware execution.",
      expectedCommand: "tcpdump -i eth0 -w malware_traffic.pcap",
      hint: "Use 'tcpdump -i eth0 -w malware_traffic.pcap' to capture network traffic",
      successMessage: "Network traffic captured. Detected C2 communications to 192.168.1.100:8080.",
      points: 35
    },
    {
      title: "Memory Analysis",
      description: "Analyze memory dump to understand runtime behavior and persistence mechanisms.",
      expectedCommand: "volatility -f memory_dump.raw --profile=Win10x64 pslist",
      hint: "Use 'volatility -f memory_dump.raw --profile=Win10x64 pslist' to list processes",
      successMessage: "Memory analysis complete. Found injected processes and hidden malware components.",
      points: 35
    }
  ];

  useEffect(() => {
    setTerminalOutput([
      "ğŸ¦  Malware Analysis & Detection Lab",
      "==================================",
      "",
      "Welcome to the Malware Analysis Lab!",
      "Learn to analyze and detect malicious software using various techniques.",
      "",
      "âš ï¸  WARNING: This is a controlled environment with simulated malware.",
      "Sample: suspicious_malware.exe (MD5: a1b2c3d4e5f6g7h8...)",
      "",
      "Analysis Objectives:",
      "â€¢ Static analysis without execution",
      "â€¢ Hash-based identification",
      "â€¢ String and signature analysis",
      "â€¢ Dynamic behavior analysis",
      "â€¢ Network communication patterns",
      "â€¢ Memory forensics",
      "",
      `Step ${currentStep + 1}/${steps.length}: ${steps[currentStep].title}`,
      steps[currentStep].description,
      "",
      "Type your command below:"
    ]);
  }, [currentStep]);

  const handleCommand = (command) => {
    const currentStepData = steps[currentStep];
    const newOutput = [...terminalOutput, `$ ${command}`];

    if (command.toLowerCase().trim() === currentStepData.expectedCommand.toLowerCase()) {
      newOutput.push("âœ… " + currentStepData.successMessage);
      newOutput.push(`ğŸ¯ Points earned: ${currentStepData.points}`);
      
      // Add finding to analysis results
      const finding = {
        step: currentStep + 1,
        technique: currentStepData.title,
        result: currentStepData.successMessage
      };
      setAnalysisFindings([...analysisFindings, finding]);
      
      const newScore = score + currentStepData.points;
      setScore(newScore);

      if (currentStep < steps.length - 1) {
        newOutput.push("");
        newOutput.push(`Step ${currentStep + 2}/${steps.length}: ${steps[currentStep + 1].title}`);
        newOutput.push(steps[currentStep + 1].description);
        newOutput.push("");
        setCurrentStep(currentStep + 1);
      } else {
        newOutput.push("");
        newOutput.push("ğŸ‰ Malware Analysis Complete!");
        newOutput.push(`ğŸ† Final Score: ${newScore}/200 points`);
        newOutput.push("");
        newOutput.push("ğŸ“Š MALWARE ANALYSIS REPORT");
        newOutput.push("=========================");
        newOutput.push("Sample: suspicious_malware.exe");
        newOutput.push("Verdict: MALICIOUS");
        newOutput.push("");
        newOutput.push("Key Findings:");
        newOutput.push("â€¢ File Type: PE32 Windows executable");
        newOutput.push("â€¢ Packing: UPX packed (evasion technique)");
        newOutput.push("â€¢ C2 Communication: 192.168.1.100:8080");
        newOutput.push("â€¢ Persistence: Registry modifications detected");
        newOutput.push("â€¢ Process Injection: Hollowing technique used");
        newOutput.push("");
        newOutput.push("ğŸš¨ Threat Classification: Advanced Persistent Threat (APT)");
        newOutput.push("ğŸ›¡ï¸ Recommended Actions:");
        newOutput.push("1. Block C2 domains/IPs at network level");
        newOutput.push("2. Update antivirus signatures");
        newOutput.push("3. Hunt for similar samples in environment");
        newOutput.push("4. Implement behavioral detection rules");
        newOutput.push("5. Conduct incident response procedures");
        setLabCompleted(true);
      }
    } else if (command.toLowerCase().trim() === 'hint') {
      newOutput.push("ğŸ’¡ Hint: " + currentStepData.hint);
    } else if (command.toLowerCase().trim() === 'help') {
      newOutput.push("Available commands:");
      newOutput.push("â€¢ hint - Get a hint for the current step");
      newOutput.push("â€¢ help - Show this help message");
      newOutput.push("â€¢ clear - Clear the terminal");
      newOutput.push("â€¢ findings - Show current analysis findings");
    } else if (command.toLowerCase().trim() === 'findings') {
      newOutput.push("ğŸ“‹ Current Analysis Findings:");
      analysisFindings.forEach((finding, index) => {
        newOutput.push(`${index + 1}. ${finding.technique}: ${finding.result}`);
      });
    } else if (command.toLowerCase().trim() === 'clear') {
      setTerminalOutput([]);
      return;
    } else {
      newOutput.push("âŒ Incorrect command. Type 'hint' for help or 'help' for available commands.");
    }

    setTerminalOutput(newOutput);
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    if (userInput.trim()) {
      handleCommand(userInput.trim());
      setUserInput('');
    }
  };

  return (
    <div className="lab-container">
      <div className="lab-header">
        <div className="lab-title">
          <span className="lab-icon">ğŸ¦ </span>
          <div>
            <h1>Malware Analysis & Detection</h1>
            <p>Advanced malware analysis techniques and threat detection</p>
          </div>
        </div>
        <div className="lab-controls">
          <div className="lab-score">Score: {score}/200</div>
          <button onClick={onClose} className="btn ghost">Exit Lab</button>
        </div>
      </div>

      <div className="lab-content">
        <div className="terminal-container">
          <div className="terminal-header">
            <div className="terminal-title">ğŸ¦  Malware Analysis Terminal</div>
            <div className="terminal-status">
              Step {currentStep + 1}/{steps.length} | 
              {labCompleted ? ' âœ… Analysis Complete' : ' ğŸ”„ Analyzing...'}
            </div>
          </div>
          
          <div className="terminal-body">
            <div className="terminal-output">
              {terminalOutput.map((line, index) => (
                <div key={index} className="terminal-line">
                  {line}
                </div>
              ))}
            </div>
            
            {!labCompleted && (
              <form onSubmit={handleSubmit} className="terminal-input-form">
                <div className="terminal-input-line">
                  <span className="terminal-prompt">analyst@malware-lab:~$ </span>
                  <input
                    type="text"
                    value={userInput}
                    onChange={(e) => setUserInput(e.target.value)}
                    className="terminal-input"
                    placeholder="Enter your command..."
                    autoFocus
                  />
                </div>
              </form>
            )}
          </div>
        </div>

        <div className="lab-sidebar">
          <div className="lab-progress">
            <h3>ğŸ¯ Analysis Progress</h3>
            <div className="progress-bar">
              <div 
                className="progress-fill" 
                style={{ width: `${((currentStep + (labCompleted ? 1 : 0)) / steps.length) * 100}%` }}
              ></div>
            </div>
            <p>{currentStep + (labCompleted ? 1 : 0)}/{steps.length} techniques completed</p>
          </div>

          <div className="lab-objectives">
            <h3>ğŸ”¬ Analysis Techniques</h3>
            <ul>
              {steps.map((step, index) => (
                <li key={index} className={index < currentStep ? 'completed' : index === currentStep ? 'current' : ''}>
                  {step.title}
                  {index < currentStep && <span className="checkmark">âœ…</span>}
                  {index === currentStep && <span className="current-marker">ğŸ‘ˆ</span>}
                </li>
              ))}
            </ul>
          </div>

          <div className="analysis-findings">
            <h3>ğŸ” Analysis Findings</h3>
            {analysisFindings.length > 0 ? (
              <ul>
                {analysisFindings.map((finding, index) => (
                  <li key={index} className="finding-item">
                    <strong>{finding.technique}</strong>
                    <p>{finding.result}</p>
                  </li>
                ))}
              </ul>
            ) : (
              <p>No findings yet...</p>
            )}
          </div>

          <div className="lab-tips">
            <h3>ğŸ’¡ Analysis Tips</h3>
            <ul>
              <li>Always analyze in isolated environment</li>
              <li>Start with static analysis before dynamic</li>
              <li>Document all findings and IOCs</li>
              <li>Use multiple analysis techniques</li>
              <li>Correlate findings across different tools</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  );
};

export default MalwareAnalysisLab;