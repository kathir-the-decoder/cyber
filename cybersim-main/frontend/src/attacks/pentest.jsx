import React, { useState, useRef, useEffect } from "react";
import "../App.css";
import "../labs.css";

export default function PentestLab({ onClose }) {
  const [input, setInput] = useState("");
  const [outputs, setOutputs] = useState([]);
  const [history, setHistory] = useState([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [cursorVisible, setCursorVisible] = useState(true);
  const [booted, setBooted] = useState(false);
  const [currentPhase, setCurrentPhase] = useState(0);

  const terminalRef = useRef(null);

  // Penetration Testing Phases
  const phases = [
    { name: "Reconnaissance", key: "recon", description: "Information gathering and target analysis" },
    { name: "Scanning", key: "scanning", description: "Network and service discovery" },
    { name: "Enumeration", key: "enumeration", description: "Detailed service analysis" },
    { name: "Exploitation", key: "exploitation", description: "Gaining initial access" },
    { name: "Post-Exploitation", key: "post-exploit", description: "Privilege escalation and persistence" },
    { name: "Reporting", key: "reporting", description: "Document findings and recommendations" }
  ];

  const [phaseStatus, setPhaseStatus] = useState({
    recon: false,
    scanning: false,
    enumeration: false,
    exploitation: false,
    "post-exploit": false,
    reporting: false
  });

  const [targetInfo, setTargetInfo] = useState({
    ip: "192.168.1.100",
    hostname: "target-server",
    os: "Unknown",
    openPorts: [],
    services: [],
    vulnerabilities: [],
    exploited: false
  });

  const delay = (ms) => new Promise((res) => setTimeout(res, ms));
  const scrollBottom = () => {
    requestAnimationFrame(() => {
      if (terminalRef.current) terminalRef.current.scrollTop = terminalRef.current.scrollHeight;
    });
  };

  const pushOut = async (text, type = "out") => {
    setOutputs((o) => [...o, { type, text }]);
    await delay(10);
    scrollBottom();
  };

  const markPhaseComplete = (phase) => {
    setPhaseStatus(prev => ({ ...prev, [phase]: true }));
    if (phases.findIndex(p => p.key === phase) === currentPhase) {
      setCurrentPhase(prev => Math.min(prev + 1, phases.length - 1));
    }
  };

  // Penetration Testing Commands
  const COMMANDS = [
    {
      match: (cmd) => /^(whois|dig|nslookup)/.test(cmd),
      run: async (cmd) => {
        await pushOut("Performing reconnaissance...");
        await delay(800);
        if (cmd.includes('whois')) {
          await pushOut("WHOIS Information:");
          await pushOut("Domain: target-corp.com");
          await pushOut("Registrar: Example Registrar Inc.");
          await pushOut("Admin Email: admin@target-corp.com");
          await pushOut("Name Servers: ns1.target-corp.com, ns2.target-corp.com");
        } else {
          await pushOut("DNS Information:");
          await pushOut("target-server.com    A    192.168.1.100");
          await pushOut("mail.target-server.com    MX    192.168.1.101");
          await pushOut("www.target-server.com    CNAME    target-server.com");
        }
        setTargetInfo(prev => ({ ...prev, hostname: "target-server.com" }));
        markPhaseComplete("recon");
      },
    },
    {
      match: (cmd) => /^nmap/.test(cmd),
      run: async (cmd) => {
        await pushOut("Starting Nmap scan...");
        await delay(1200);
        
        if (cmd.includes('-sS') || cmd.includes('syn')) {
          await pushOut("Nmap SYN scan results:");
          await pushOut("PORT     STATE SERVICE");
          await pushOut("22/tcp   open  ssh");
          await pushOut("80/tcp   open  http");
          await pushOut("443/tcp  open  https");
          await pushOut("3306/tcp open  mysql");
          setTargetInfo(prev => ({ 
            ...prev, 
            openPorts: ["22/tcp", "80/tcp", "443/tcp", "3306/tcp"]
          }));
        } else if (cmd.includes('-sV') || cmd.includes('version')) {
          await pushOut("Nmap version detection:");
          await pushOut("22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)");
          await pushOut("80/tcp   open  http    Apache httpd 2.4.6");
          await pushOut("443/tcp  open  https   Apache httpd 2.4.6 (SSL)");
          await pushOut("3306/tcp open  mysql   MySQL 5.7.25");
          setTargetInfo(prev => ({ 
            ...prev, 
            services: ["OpenSSH 7.4", "Apache 2.4.6", "MySQL 5.7.25"],
            os: "Linux (CentOS 7)"
          }));
        } else if (cmd.includes('-sC') || cmd.includes('script')) {
          await pushOut("Nmap script scan results:");
          await pushOut("22/tcp: ssh-hostkey reveals weak keys");
          await pushOut("80/tcp: http-enum found /admin directory");
          await pushOut("443/tcp: ssl-cert shows self-signed certificate");
          await pushOut("3306/tcp: mysql-info shows root access allowed");
          setTargetInfo(prev => ({ 
            ...prev, 
            vulnerabilities: ["Weak SSH keys", "Admin directory exposed", "Self-signed SSL", "MySQL root access"]
          }));
        } else {
          await pushOut("Basic port scan completed");
          await pushOut("Found 4 open ports on target");
        }
        markPhaseComplete("scanning");
      },
    },
    {
      match: (cmd) => /^(nikto|dirb|gobuster)/.test(cmd),
      run: async (cmd) => {
        await pushOut("Starting web application enumeration...");
        await delay(1000);
        
        if (cmd.includes('nikto')) {
          await pushOut("Nikto web vulnerability scan:");
          await pushOut("+ Server: Apache/2.4.6 (CentOS)");
          await pushOut("+ OSVDB-3268: /admin/: Directory indexing found");
          await pushOut("+ OSVDB-3092: /admin/: This might be interesting");
          await pushOut("+ /login.php: Admin login page found");
          await pushOut("+ /config.php.bak: Configuration backup found");
        } else if (cmd.includes('dirb') || cmd.includes('gobuster')) {
          await pushOut("Directory brute force results:");
          await pushOut("200   /admin/");
          await pushOut("200   /login.php");
          await pushOut("200   /uploads/");
          await pushOut("403   /config/");
          await pushOut("200   /backup.sql");
        }
        markPhaseComplete("enumeration");
      },
    },
    {
      match: (cmd) => /^(sqlmap|hydra|metasploit|msfconsole)/.test(cmd),
      run: async (cmd) => {
        await pushOut("Attempting exploitation...");
        await delay(1200);
        
        if (cmd.includes('sqlmap')) {
          await pushOut("SQLMap injection testing:");
          await pushOut("Parameter 'id' is vulnerable to SQL injection");
          await pushOut("Database: MySQL 5.7.25");
          await pushOut("Available databases: information_schema, users, products");
          await pushOut("Successfully extracted admin credentials");
        } else if (cmd.includes('hydra')) {
          await pushOut("Hydra brute force attack:");
          await pushOut("Attempting SSH login brute force...");
          await pushOut("Success: admin:password123");
          await pushOut("Valid credentials found!");
        } else if (cmd.includes('metasploit') || cmd.includes('msfconsole')) {
          await pushOut("Metasploit Framework:");
          await pushOut("Using exploit/linux/http/apache_mod_cgi_bash_env_exec");
          await pushOut("Payload: linux/x86/meterpreter/reverse_tcp");
          await pushOut("Exploit completed successfully!");
          await pushOut("Meterpreter session opened");
          setTargetInfo(prev => ({ ...prev, exploited: true }));
        }
        markPhaseComplete("exploitation");
      },
    },
    {
      match: (cmd) => /^(whoami|id|sudo|find|cat)/.test(cmd),
      run: async (cmd) => {
        if (!targetInfo.exploited) {
          await pushOut("Error: No active session. Exploit target first.");
          return;
        }
        
        await pushOut("Post-exploitation command executed:");
        await delay(600);
        
        if (cmd.includes('whoami')) {
          await pushOut("www-data");
        } else if (cmd.includes('id')) {
          await pushOut("uid=33(www-data) gid=33(www-data) groups=33(www-data)");
        } else if (cmd.includes('sudo -l')) {
          await pushOut("User www-data may run the following commands:");
          await pushOut("    (root) NOPASSWD: /usr/bin/systemctl");
        } else if (cmd.includes('find') && cmd.includes('suid')) {
          await pushOut("SUID binaries found:");
          await pushOut("/usr/bin/passwd");
          await pushOut("/usr/bin/sudo");
          await pushOut("/usr/local/bin/custom-tool");
        } else if (cmd.includes('cat') && cmd.includes('flag')) {
          await pushOut("flag{pentest_lab_complete_advanced_techniques}");
        }
        markPhaseComplete("post-exploit");
      },
    },
    {
      match: (cmd) => /^(report|document)/.test(cmd),
      run: async () => {
        await pushOut("Generating penetration test report...");
        await delay(800);
        await pushOut("PENETRATION TEST REPORT");
        await pushOut("========================");
        await pushOut("Target: " + targetInfo.ip);
        await pushOut("OS: " + targetInfo.os);
        await pushOut("Open Ports: " + targetInfo.openPorts.join(", "));
        await pushOut("Critical Vulnerabilities: " + targetInfo.vulnerabilities.length);
        await pushOut("Exploitation Status: " + (targetInfo.exploited ? "SUCCESS" : "FAILED"));
        await pushOut("Risk Level: HIGH");
        await pushOut("Recommendations: Patch systems, update configurations");
        markPhaseComplete("reporting");
      },
    },
    {
      match: (cmd) => /^(target|info)$/.test(cmd),
      run: async () => {
        await pushOut("TARGET INFORMATION:");
        await pushOut("IP Address: " + targetInfo.ip);
        await pushOut("Hostname: " + targetInfo.hostname);
        await pushOut("Operating System: " + targetInfo.os);
        await pushOut("Open Ports: " + (targetInfo.openPorts.length > 0 ? targetInfo.openPorts.join(", ") : "Not scanned"));
        await pushOut("Services: " + (targetInfo.services.length > 0 ? targetInfo.services.join(", ") : "Not enumerated"));
        await pushOut("Vulnerabilities: " + targetInfo.vulnerabilities.length);
        await pushOut("Exploited: " + (targetInfo.exploited ? "YES" : "NO"));
      },
    },
    {
      match: (cmd) => /^(help|\?)$/.test(cmd),
      run: async () => {
        await pushOut(
          "Penetration Testing Commands:\n" +
            "RECONNAISSANCE:\n" +
            "- whois target-corp.com\n" +
            "- dig target-server.com\n" +
            "\nSCANNING:\n" +
            "- nmap -sS 192.168.1.100\n" +
            "- nmap -sV 192.168.1.100\n" +
            "- nmap -sC 192.168.1.100\n" +
            "\nENUMERATION:\n" +
            "- nikto -h http://192.168.1.100\n" +
            "- dirb http://192.168.1.100\n" +
            "\nEXPLOITATION:\n" +
            "- sqlmap -u 'http://target/page.php?id=1'\n" +
            "- hydra -l admin -P passwords.txt ssh://192.168.1.100\n" +
            "- msfconsole\n" +
            "\nPOST-EXPLOITATION:\n" +
            "- whoami\n" +
            "- sudo -l\n" +
            "- find / -perm -4000 2>/dev/null\n" +
            "\nOTHER:\n" +
            "- target (show target info)\n" +
            "- report (generate report)"
        );
      },
    },
  ];

  const handleCommand = async (raw) => {
    const cmd = raw.trim();
    if (!cmd) return;
    setHistory((h) => [cmd, ...h].slice(0, 50));
    setInput("");
    setOutputs((o) => [...o, { type: "cmd", text: `$ ${cmd}` }]);
    setIsProcessing(true);

    const match = COMMANDS.find((c) => c.match(cmd));
    if (match) await match.run(cmd);
    else await pushOut(`bash: ${cmd.split(" ")[0]}: command not found`, "err");

    setIsProcessing(false);
  };

  const onKeyDown = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleCommand(input);
    }
  };

  useEffect(() => {
    const blink = setInterval(() => setCursorVisible((v) => !v), 600);
    return () => clearInterval(blink);
  }, []);

  useEffect(() => {
    if (booted) return;
    const boot = async () => {
      await pushOut("Welcome to Penetration Testing Lab", "sys");
      await delay(400);
      await pushOut("Target: 192.168.1.100 (target-server)", "sys");
      await delay(400);
      await pushOut("Objective: Complete full penetration test", "sys");
      await delay(400);
      await pushOut("Type 'help' for available commands", "sys");
      await delay(400);
      await pushOut("Start with reconnaissance: whois target-corp.com", "sys");
      setBooted(true);
    };
    boot();
  }, [booted]);

  const computeProgress = () => {
    const completed = Object.values(phaseStatus).filter(Boolean).length;
    return Math.round((completed / phases.length) * 100);
  };

  return (
    <div style={{ padding: 16, maxWidth: 1200, margin: '0 auto', color: '#fff' }}>
      <header style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'baseline', marginBottom: 16 }}>
        <div>
          <h2 style={{ margin: '0 0 6px 0' }}>Penetration Testing Lab</h2>
          <div style={{ color: '#cbd5e1' }}>Complete penetration test methodology from reconnaissance to reporting.</div>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <button className="btn ghost" onClick={() => { if (onClose) onClose() }}>Exit</button>
          <button className="btn" onClick={() => { 
            setOutputs([]); 
            setPhaseStatus({ recon: false, scanning: false, enumeration: false, exploitation: false, "post-exploit": false, reporting: false });
            setTargetInfo({ ip: "192.168.1.100", hostname: "target-server", os: "Unknown", openPorts: [], services: [], vulnerabilities: [], exploited: false });
            setCurrentPhase(0);
          }}>Reset</button>
        </div>
      </header>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 400px', gap: 16 }}>
        {/* Terminal Section */}
        <div style={{ border: '1px solid rgba(0, 102, 255, 0.2)', borderRadius: 12, overflow: 'hidden', background: 'linear-gradient(145deg, rgba(26, 31, 46, 0.8), rgba(15, 20, 32, 0.8))' }}>
          <div style={{ padding: 12, background: 'rgba(0, 102, 255, 0.1)', borderBottom: '1px solid rgba(0, 102, 255, 0.2)' }}>
            <h3 style={{ margin: 0, fontSize: '1rem' }}>Penetration Testing Terminal</h3>
          </div>
          <div ref={terminalRef} style={{ height: 400, overflow: 'auto', padding: 16, fontFamily: 'monospace', fontSize: 14, background: '#0a0e1a' }}>
            {outputs.map((o, i) => (
              <TerminalLine key={i} {...o} />
            ))}
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <span style={{ color: '#ef4444' }}>kali@pentest:~$</span>
              <input
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={onKeyDown}
                style={{ 
                  flex: 1, 
                  background: 'transparent', 
                  border: 'none', 
                  outline: 'none', 
                  color: '#fff', 
                  fontFamily: 'monospace',
                  fontSize: 14
                }}
                spellCheck={false}
                autoFocus
              />
              <span style={{ color: cursorVisible ? '#fff' : 'transparent' }}>█</span>
            </div>
          </div>
        </div>

        {/* Status Panel */}
        <div style={{ display: 'flex', flexDirection: 'column', gap: 16 }}>
          {/* Progress */}
          <div style={{ border: '1px solid rgba(0, 102, 255, 0.2)', borderRadius: 12, padding: 16, background: 'linear-gradient(145deg, rgba(26, 31, 46, 0.8), rgba(15, 20, 32, 0.8))' }}>
            <h3 style={{ margin: '0 0 12px 0', fontSize: '1.1rem' }}>Progress</h3>
            <div style={{ 
              width: '100%', 
              height: 8, 
              background: 'rgba(255,255,255,0.1)', 
              borderRadius: 4, 
              overflow: 'hidden',
              marginBottom: 8
            }}>
              <div style={{ 
                width: `${computeProgress()}%`, 
                height: '100%', 
                background: 'linear-gradient(90deg, #ef4444, #f59e0b)',
                transition: 'width 0.3s ease'
              }}></div>
            </div>
            <p style={{ margin: 0, fontSize: '0.9rem', color: '#cbd5e1' }}>{computeProgress()}% complete</p>
          </div>

          {/* Phases */}
          <div style={{ border: '1px solid rgba(0, 102, 255, 0.2)', borderRadius: 12, padding: 16, background: 'linear-gradient(145deg, rgba(26, 31, 46, 0.8), rgba(15, 20, 32, 0.8))' }}>
            <h3 style={{ margin: '0 0 12px 0', fontSize: '1.1rem' }}>Testing Phases</h3>
            <ul style={{ listStyle: 'none', padding: 0, margin: 0 }}>
              {phases.map((phase, i) => (
                <li key={phase.key} style={{ marginBottom: 12 }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginBottom: 4 }}>
                    <span style={{ 
                      color: phaseStatus[phase.key] ? '#10b981' : (i === currentPhase ? '#f59e0b' : '#6b7280'),
                      fontSize: '1.2rem'
                    }}>
                      {phaseStatus[phase.key] ? "✓" : (i === currentPhase ? "→" : "○")}
                    </span>
                    <span style={{ 
                      color: phaseStatus[phase.key] ? '#10b981' : (i === currentPhase ? '#f59e0b' : '#e5e7eb'),
                      fontSize: '0.9rem',
                      fontWeight: i === currentPhase ? 'bold' : 'normal'
                    }}>
                      {phase.name}
                    </span>
                  </div>
                  <div style={{ 
                    fontSize: '0.8rem', 
                    color: '#94a3b8', 
                    marginLeft: 28
                  }}>
                    {phase.description}
                  </div>
                </li>
              ))}
            </ul>
          </div>

          {/* Target Info */}
          <div style={{ border: '1px solid rgba(0, 102, 255, 0.2)', borderRadius: 12, padding: 16, background: 'linear-gradient(145deg, rgba(26, 31, 46, 0.8), rgba(15, 20, 32, 0.8))' }}>
            <h3 style={{ margin: '0 0 12px 0', fontSize: '1.1rem' }}>Target Information</h3>
            <div style={{ display: 'grid', gap: 8, fontSize: '0.9rem' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>IP Address:</span>
                <span style={{ color: '#0066FF', fontFamily: 'monospace' }}>{targetInfo.ip}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>Hostname:</span>
                <span style={{ color: '#0066FF', fontFamily: 'monospace' }}>{targetInfo.hostname}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>OS:</span>
                <span style={{ color: '#0066FF' }}>{targetInfo.os}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>Open Ports:</span>
                <span style={{ color: targetInfo.openPorts.length > 0 ? '#f59e0b' : '#6b7280' }}>
                  {targetInfo.openPorts.length}
                </span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>Vulnerabilities:</span>
                <span style={{ color: targetInfo.vulnerabilities.length > 0 ? '#ef4444' : '#6b7280' }}>
                  {targetInfo.vulnerabilities.length}
                </span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <span>Exploited:</span>
                <span style={{ color: targetInfo.exploited ? '#ef4444' : '#6b7280' }}>
                  {targetInfo.exploited ? 'YES' : 'NO'}
                </span>
              </div>
            </div>
          </div>

          {/* Quick Commands */}
          <div style={{ border: '1px solid rgba(0, 102, 255, 0.2)', borderRadius: 12, padding: 16, background: 'linear-gradient(145deg, rgba(26, 31, 46, 0.8), rgba(15, 20, 32, 0.8))' }}>
            <h3 style={{ margin: '0 0 12px 0', fontSize: '1.1rem' }}>Quick Commands</h3>
            <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
              <button 
                className="btn primary" 
                onClick={() => setInput("nmap -sV 192.168.1.100")}
                style={{ fontSize: '0.8rem' }}
              >
                Version Scan
              </button>
              <button 
                className="btn primary" 
                onClick={() => setInput("nikto -h http://192.168.1.100")}
                style={{ fontSize: '0.8rem' }}
              >
                Web Vulnerability Scan
              </button>
              <button 
                className="btn primary" 
                onClick={() => setInput("target")}
                style={{ fontSize: '0.8rem' }}
              >
                Show Target Info
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function TerminalLine({ type, text }) {
  const color =
    type === "cmd"
      ? "#ef4444"
      : type === "err"
      ? "#ef4444"
      : type === "sys"
      ? "#10b981"
      : "#e5e7eb";
  return <pre style={{ margin: 0, color, whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>{text}</pre>;
}